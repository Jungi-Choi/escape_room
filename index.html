<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì¸ë§Œ íƒˆì¶œ ê°€ëŠ¥í•œ ë°©íƒˆì¶œ ê²Œì„ (ë°˜ì‘í˜• + ìŠ¤í¬ë¡¤)</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
            overflow-x: hidden;
            display: block;
        }

        h1, h2 {
            color: #ffc107;
            text-shadow: 2px 2px 4px #000;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: transform 0.2s, background-color 0.2s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 1000;
        }
        #start-screen h1 { font-size: 3em; }
        #best-record-display { margin: 20px 0; font-size: 1.2em; color: #00bcd4; }
        #start-button {
            padding: 15px 30px;
            font-size: 1.5em;
            background: linear-gradient(45deg, #ffc107, #ff9800);
            color: #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        #game-container {
            position: relative;
            width: 95vw;
            max-width: 900px;
            border: 2px solid #fff;
            background-color: #000;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            text-align: center;
            display: none;
            margin: 20px auto;
            padding-bottom: 20px;
        }

        /* ìƒë‹¨ ë°” (ì¢Œ: í‹€ë¦°íšŸìˆ˜, ìš°: íƒ€ì´ë¨¸, ë‹¨ì„œ) */
        #wrong-answer-counter {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #ff6b6b;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        #top-bar {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 10;
        }
        #timer {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff4545;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }
        #era-clue-button {
            padding: 8px 12px;
            font-size: 0.9em;
            background-color: #00bcd4;
            color: white;
        }
        #era-clue-button:disabled { background-color: #555; cursor: not-allowed; }

        /* ë°© í™”ë©´ */
        #room-screen {
            position: relative;
            width: 100%;
            padding-top: 66.66%;
            background-color: #111;
        }
        #room-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* í´ë¦­ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸ */
        .clickable-object {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.2);
            border: 2px dashed yellow;
            cursor: pointer;
            transition: background-color 0.3s, border 0.3s;
        }
        .clickable-object:hover { background-color: rgba(255, 0, 0, 0.4); border: 2px solid red; }
        .clickable-object.solved { background-color: rgba(0, 255, 0, 0.3); border: 2px solid limegreen; cursor: not-allowed; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls { padding: 20px; background-color: #222; }
        #hints-list { list-style-type: 'ğŸ’¡ '; padding-left: 20px; text-align: left; min-height: 50px; }
        #password-form { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        #password-input { padding: 10px; font-size: 1em; width: 200px; border-radius: 5px; border: 1px solid #ccc; }
        #password-submit { padding: 10px 20px; font-size: 1em; background-color: #ffc107; color: #000; }
        
        /* ë°© ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ */
        #transition-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; opacity: 0; z-index: 999;
            pointer-events: none; transition: opacity 0.5s ease-in-out;
        }
        #transition-overlay.active { opacity: 1; }

        /* ê²Œì„ ì˜¤ë²„ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #game-over-screen {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        #game-over-screen img {
            max-width: 80%;
            max-height: 50vh;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }
        #game-over-screen p {
            font-size: 1.5em;
            color: #ff6b6b;
            margin: 20px 0;
            font-weight: bold;
        }
        #restart-from-game-over {
            padding: 10px 25px;
            font-size: 1.2em;
            background-color: #00bcd4;
            color: white;
        }

        /* --- Custom Modal Styles --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000; /* Higher than other game elements */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #222;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.3);
            text-align: center;
            max-width: 90%;
            width: 400px;
            animation: fadeIn 0.3s ease-out;
            color: #fff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content p {
            font-size: 1.3em;
            margin-bottom: 20px;
            word-wrap: break-word; /* Long messages break lines */
        }

        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em;
            background-color: #333;
            color: #fff;
        }

        .modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 1em;
            border-radius: 5px;
            background-color: #ffc107;
            color: #000;
        }

        .modal-buttons .modal-cancel-button {
            background-color: #555;
            color: #fff;
        }
        /* End Custom Modal Styles */

        /* --- ë°˜ì‘í˜• ë””ìì¸ì„ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ --- */

        /* íƒœë¸”ë¦¿ ì‚¬ì´ì¦ˆ (768px ì´í•˜) */
        @media (max-width: 768px) {
            #start-screen h1 { font-size: 2.5em; }
            #start-button { font-size: 1.3em; padding: 12px 25px; }
            
            #room-title { font-size: 1.5em; }
            #controls h2 { font-size: 1.2em; }

            #password-form {
                flex-direction: column;
                align-items: center;
            }
            #password-input { width: 80%; }
        }

        /* ëª¨ë°”ì¼ ì‚¬ì´ì¦ˆ (480px ì´í•˜) */
        @media (max-width: 480px) {
            #start-screen h1 { font-size: 2em; }
            #start-button { font-size: 1.1em; padding: 10px 20px; }
            #best-record-display { font-size: 1em; }

            #game-container { border: none; margin: 10px auto; }

            #wrong-answer-counter { font-size: 0.9em; top: 10px; left: 10px; }
            #top-bar { top: 10px; right: 10px; gap: 5px; }
            #timer { font-size: 1em; }
            #era-clue-button { font-size: 0.8em; padding: 6px 10px; }

            #room-title { font-size: 1.2em; margin-top: 50px; }
            #controls { padding: 15px; }
            #hints-list { padding-left: 15px; font-size: 0.9em; }
            
            #game-over-screen p { font-size: 1.2em; }
            #restart-from-game-over { font-size: 1em; }

            .modal-content {
                padding: 20px;
                width: 95%; /* Adjust width for smaller screens */
            }
            .modal-content p {
                font-size: 1.1em;
            }
            .modal-input {
                font-size: 1em;
            }
            .modal-buttons button {
                padding: 8px 15px;
                font-size: 0.9em;
                margin: 0 5px;
            }
        }
    </style>
</head>
<body>

    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen">
        <h1>í•œêµ­ì¸ë§Œ íƒˆì¶œ ê°€ëŠ¥í•œ ë°©íƒˆì¶œ</h1>
        <div id="best-record-display">
            <h2>ìµœê³  ê¸°ë¡</h2>
            <p id="record-text">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <button id="start-button">ê²Œì„ ì‹œì‘</button>
    </div>

    <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
    <div id="game-container">
        <div id="wrong-answer-counter"></div>
        <div id="top-bar">
            <div id="timer">00:00</div>
            <button id="era-clue-button"></button>
        </div>
        <h1 id="room-title"></h1>
        <div id="room-screen">
            <img id="room-image" src="" alt="ë°© ì´ë¯¸ì§€">
            <div id="objects-container"></div>
        </div>
        <div id="controls">
            <h2>íšë“í•œ íŒíŠ¸</h2>
            <ul id="hints-list"></ul>
            <div id="password-form">
                <input type="text" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button id="password-submit">íƒˆì¶œ ì‹œë„</button>
            </div>
        </div>
    </div>

    <!-- ë°© ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ìš© ì˜¤ë²„ë ˆì´ -->
    <div id="transition-overlay"></div>

    <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
    <div id="game-over-screen">
        <img src="https://github.com/Jungi-Choi/escape_room/blob/main/%E1%84%82%E1%85%A1%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%80%E1%85%A1%E1%84%85%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%B7.jpeg?raw=true" alt="ê²Œì„ ì˜¤ë²„ ì´ë¯¸ì§€">
        <p>4ê°œë‚˜ í‹€ë¦° ë‹¹ì‹ ì€ ì´ ë°©ì„ í‰ìƒ íƒˆì¶œ ëª» í• ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì´ëŸ° ê²ƒ í•˜ì§€ ë§ê³  ì—­ì‚¬ ê³µë¶€ë‚˜ í•˜ì„¸ìš”. :)</p>
        <button id="restart-from-game-over">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message"></p>
            <input type="text" id="modal-input" class="modal-input" placeholder="ì…ë ¥í•˜ì„¸ìš”...">
            <div class="modal-buttons">
                <button id="modal-ok">í™•ì¸</button>
                <button id="modal-cancel" class="modal-cancel-button">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameData = [
                {
                    name: '3.1ìš´ë™',
                    image : 'https://raw.githubusercontent.com/Jungi-Choi/escape_room/1746c54b4ba88328c90d25d91ca321d64c266fbc/%E1%84%83%E1%85%A9%E1%86%A8%E1%84%85%E1%85%B5%E1%86%B8%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%83%E1%85%A9%E1%86%BC.jpg',
                    password: '1919ë…ë¦½',
                    objects: [ { id: 'obj1', pos: { top: '50%', left: '25%', width: '7%', height: '10%' }, puzzle: 'ì´ ì¢…ì´ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”? (ì´ˆì„±íŒíŠ¸: ã„·ã„¹ã……ã…‡ã…)', answer: 'ë…ë¦½ì„ ì–¸ë¬¸', hint: 'ì´ ë°©ì˜ ë¹„ë°€ë²ˆí˜¸ì™€ëŠ” ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì—†ëŠ” ë‹¨ì„œì´ë‹¤.', validation: { type: 'length', value: 5 } } ],
                    eraPuzzles: [ { id: 'era1', puzzle: '3.1ìš´ë™ì´ ì¼ì–´ë‚œ ì—°ë„ëŠ”? (ìˆ«ì 4ìë¦¬)', answer: '1919', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ì• 4ìë¦¬ëŠ” [ 1919 ] ì´ë‹¤.", validation: { type: 'regex', value: /^\d{4}$/ } }, { id: 'era2', puzzle: '3.1ìš´ë™ì˜ ëª©ì ì€ ë¬´ì—‡ì¼ê¹Œìš”? (ì¡°ì„ ì˜ OO)', answer: 'ë…ë¦½', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ë’¤ 2ê¸€ìëŠ” [ ë…ë¦½ ] ì´ë‹¤.", validation: { type: 'length', value: 2 } } ]
                },
                {
                    name: 'ë‘ ë²ˆì§¸ ë°©: ê³ êµ¬ë ¤ì˜ ê¸°ìƒ',
                    image : 'https://raw.githubusercontent.com/Jungi-Choi/escape_room/1746c54b4ba88328c90d25d91ca321d64c266fbc/%E1%84%89%E1%85%AE%E1%84%85%E1%85%A7%E1%86%B8%E1%84%83%E1%85%A9.jpg',
                    password: '391',
                    objects: [ { id: 'obj1', pos: { top: '30%', left: '5%', width: '30%', height: '50%' }, puzzle: "ì´ ì‚¬ëŒì€ ë¬´ìŠ¨ ë™ë¬¼ì„ ì‚¬ëƒ¥ë¼ê³  ìˆë‚˜ìš”? (3ê¸€ì)", answer: 'í˜¸ë‘ì´', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ì²« ë²ˆì§¸ ìˆ«ìëŠ” [ 3 ] ì´ë‹¤." } ],
                    eraPuzzles: [ { id: 'era1', puzzle: "ê´‘ê°œí† ëŒ€ì™•ì´ ì™•ìœ„ì— ì˜¤ë¥¸ í•´ëŠ” ëª‡ ë…„ì¼ê¹Œìš”?", answer: '391', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ì„¸ ë²ˆì§¸ ìˆ«ìëŠ” [ 1 ] ì´ë‹¤.", validation: { type: 'regex', value: /^\d{3}$/ } }, { id: 'era2' , puzzle: "ê´‘ê°œí† ëŒ€ì™•ì˜ ì•„ë“¤ë¡œ, ì•„ë²„ì§€ì˜ ì—…ì ì„ ê¸°ë¦¬ëŠ” ë¹„ì„ì„ ì„¸ìš´ ì™•ì€ ëˆ„êµ¬ì¼ê¹Œìš”?", answer: 'ì¥ìˆ˜ì™•', hint: "ì¥ìˆ˜ì™•ì´ ì™•ìœ„ì— ìˆì—ˆë˜ ê¸°ê°„(79ë…„)ì—ì„œ 70ì„ ë¹¼ë©´? ë¹„ë°€ë²ˆí˜¸ì˜ ë‘ ë²ˆì§¸ ìˆ«ìëŠ” [ 9 ] ì´ë‹¤." , validation: { type: 'length', value: 3 }} ]
                },
                {
                    name: 'ì„¸ ë²ˆì§¸ ë°©: ê³¼í•™ì˜ ë°œì „',
                    image : 'https://raw.githubusercontent.com/Jungi-Choi/escape_room/1746c54b4ba88328c90d25d91ca321d64c266fbc/%E1%84%8E%E1%85%B3%E1%86%A8%E1%84%8B%E1%85%AE%E1%84%80%E1%85%B5.png',
                    password: '1443',
                    objects: [ { id: 'obj1', pos: { top: '20%', left: '30%', width: '40%', height: '60%' }, puzzle: "ì‚¬ì§„ ì† 'ì¸¡ìš°ê¸°'ê°€ ë°œëª…ëœ ì—°ë„ëŠ”?", answer: '1442', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ì• ë‘ ìë¦¬ëŠ” [ 14 ] ì´ë‹¤." } ],
                    eraPuzzles: [ { id: 'era1', puzzle: "ì„¸ì¢…ëŒ€ì™• ì‹œëŒ€ì˜ ë˜ ë‹¤ë¥¸ ìœ„ëŒ€í•œ ê³¼í•™ ë°œëª…í’ˆìœ¼ë¡œ, ìŠ¤ìŠ¤ë¡œ ì‹œê°„ì„ ì•Œë ¤ì£¼ëŠ” ë¬¼ì‹œê³„ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", answer: 'ìê²©ë£¨', hint: "ì„¸ì¢…ëŒ€ì™•ì´ í›ˆë¯¼ì •ìŒì„ ì°½ì œí•œ í•´ëŠ” 144[ 3 ]ë…„ì´ë‹¤." }, { id: 'era2', puzzle: "ì„¸ì¢…ëŒ€ì™•ì´ í•œê¸€ì„ ë°˜í¬í•œ í•´ëŠ” 1446ë…„ì…ë‹ˆë‹¤. ì¸¡ìš°ê¸°ê°€ ë°œëª…ëœ í•´(1441ë…„)ì™€ ëª‡ ë…„ ì°¨ì´ê°€ ë‚ ê¹Œìš”?", answer: '5', hint: "ë¹„ë°€ë²ˆí˜¸ì˜ ì„¸ ë²ˆì§¸ ìˆ«ìëŠ” [ 4 ]ì´ë‹¤. (5-1)" } ]
                }
            ];

            // DOM ìš”ì†Œ
            const startScreen = document.getElementById('start-screen');
            const gameContainer = document.getElementById('game-container');
            const startButton = document.getElementById('start-button');
            const recordText = document.getElementById('record-text');
            const roomTitle = document.getElementById('room-title');
            const roomImage = document.getElementById('room-image');
            const objectsContainer = document.getElementById('objects-container');
            const hintsList = document.getElementById('hints-list');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const eraClueButton = document.getElementById('era-clue-button');
            const timerDisplay = document.getElementById('timer');
            const transitionOverlay = document.getElementById('transition-overlay');
            const wrongAnswerCounter = document.getElementById('wrong-answer-counter');
            const gameOverScreen = document.getElementById('game-over-screen');
            const restartFromGameOverButton = document.getElementById('restart-from-game-over');

            // Custom Modal Elements
            const customModal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalInput = document.getElementById('modal-input');
            const modalOkButton = document.getElementById('modal-ok');
            const modalCancelButton = document.getElementById('modal-cancel');

            // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
            let currentRoomIndex = 0;
            let solvedPuzzles = [];
            let timerInterval;
            let elapsedSeconds = 0;
            let bestRecord = JSON.parse(localStorage.getItem('bestRecord')) || { name: null, time: Infinity };
            let wrongAnswerCount = 0;
            const MAX_WRONG_ANSWERS = 4;

            // --- Custom Modal Functions ---
            function showAlert(message) {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalInput.style.display = 'none'; // Hide input for alerts
                    modalCancelButton.style.display = 'none'; // Hide cancel button for alerts
                    customModal.style.display = 'flex'; // Show modal

                    // Remove existing listeners to prevent multiple calls
                    modalOkButton.onclick = null;
                    modalOkButton.addEventListener('click', () => {
                        customModal.style.display = 'none';
                        resolve();
                    }, { once: true }); // Use { once: true } for auto-removal
                    
                    // Allow pressing Enter to close alert
                    document.addEventListener('keydown', function enterKeyListener(event) {
                        if (event.key === 'Enter' && customModal.style.display === 'flex' && modalInput.style.display === 'none') {
                            modalOkButton.click();
                            document.removeEventListener('keydown', enterKeyListener);
                        }
                    });
                });
            }

            async function showPrompt(message, validation = null) {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalInput.value = ''; // Clear previous input
                    modalInput.style.display = 'block'; // Show input for prompts
                    modalCancelButton.style.display = 'inline-block'; // Show cancel button for prompts
                    customModal.style.display = 'flex'; // Show modal
                    modalInput.focus(); // Focus on the input field

                    const handleOk = async () => {
                        const userAnswer = modalInput.value;
                        let isValid = true;
                        let errorMsg = '';

                        if (validation) {
                            if (validation.type === 'length' && userAnswer.length !== validation.value) {
                                isValid = false;
                                errorMsg = `${validation.value}ê¸€ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
                            } else if (validation.type === 'regex' && !validation.value.test(userAnswer)) {
                                isValid = false;
                                errorMsg = 'í˜•ì‹ì— ë§ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 4ìë¦¬ ìˆ«ì)';
                            }
                        }

                        if (isValid) {
                            customModal.style.display = 'none';
                            resolve(userAnswer);
                        } else {
                            await showAlert(errorMsg); // Use custom alert for validation errors
                            modalInput.focus(); // Keep focus on input after error
                        }
                    };

                    const handleCancel = () => {
                        customModal.style.display = 'none';
                        resolve(null);
                    };

                    // Remove existing listeners to prevent multiple calls
                    modalOkButton.onclick = null;
                    modalCancelButton.onclick = null;
                    modalInput.onkeyup = null;

                    modalOkButton.addEventListener('click', handleOk);
                    modalCancelButton.addEventListener('click', handleCancel);
                    modalInput.addEventListener('keyup', (event) => {
                        if (event.key === 'Enter') handleOk();
                    });
                });
            }

            // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            };

            const updateBestRecordDisplay = () => {
                if (bestRecord.name) {
                    recordText.textContent = `${bestRecord.name} - ${formatTime(bestRecord.time)}`;
                } else {
                    recordText.textContent = 'ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                }
            };

            const updateEraClueButtonState = () => {
                const room = gameData[currentRoomIndex];
                const remainingClues = room.eraPuzzles.filter(p => !solvedPuzzles.includes(p.id)).length;
                eraClueButton.textContent = `ë‹¨ì„œ (${remainingClues})`;
                eraClueButton.disabled = (remainingClues === 0);
            };

            const updateWrongAnswerDisplay = () => {
                wrongAnswerCounter.textContent = `í‹€ë¦° íšŸìˆ˜: ${wrongAnswerCount} / ${MAX_WRONG_ANSWERS}`;
            };

            // --- íƒ€ì´ë¨¸ í•¨ìˆ˜ ---
            const startTimer = () => {
                elapsedSeconds = 0;
                timerDisplay.textContent = formatTime(elapsedSeconds);
                timerInterval = setInterval(() => {
                    elapsedSeconds++;
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            };

            const stopTimer = () => clearInterval(timerInterval);

            // --- ê²Œì„ íë¦„ í•¨ìˆ˜ ---
            const startGame = () => {
                startScreen.style.display = 'none';
                gameContainer.style.display = 'block';
                currentRoomIndex = 0;
                wrongAnswerCount = 0;
                updateWrongAnswerDisplay();
                startTimer();
                loadRoom(currentRoomIndex);
            };

            const endGame = async () => {
                stopTimer();
                await showAlert(`íƒˆì¶œ ì„±ê³µ! ê¸°ë¡: ${formatTime(elapsedSeconds)}`);
                if (elapsedSeconds < bestRecord.time) {
                    const name = await showPrompt(`ìµœê³  ê¸°ë¡ ê°±ì‹ ! ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:`);
                    if (name) {
                        bestRecord = { name, time: elapsedSeconds };
                        localStorage.setItem('bestRecord', JSON.stringify(bestRecord));
                        await showAlert(`${name}ë‹˜ì˜ ìƒˆë¡œìš´ ìµœê³  ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    }
                }
                gameContainer.style.display = 'none';
                startScreen.style.display = 'flex';
                updateBestRecordDisplay();
            };

            const triggerGameOver = () => {
                stopTimer();
                gameContainer.style.display = 'none';
                gameOverScreen.style.display = 'flex';
            };

            const loadRoom = (roomIndex) => {
                hintsList.innerHTML = '';
                objectsContainer.innerHTML = '';
                passwordInput.value = '';
                solvedPuzzles = [];
                const room = gameData[roomIndex];
                roomTitle.textContent = room.name;
                roomImage.src = room.image;
                updateEraClueButtonState();
                room.objects.forEach(obj => {
                    const objElement = document.createElement('div');
                    objElement.className = 'clickable-object';
                    Object.assign(objElement.style, obj.pos);
                    objElement.addEventListener('click', () => handleObjectClick(obj));
                    objectsContainer.appendChild(objElement);
                    obj.element = objElement;
                });
            };
            
            const transitionToNextRoom = () => {
                transitionOverlay.classList.add('active');
                setTimeout(() => {
                    currentRoomIndex++;
                    loadRoom(currentRoomIndex);
                    transitionOverlay.classList.remove('active');
                }, 600);
            };

            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
            const handlePuzzleSolved = async (puzzle) => {
                await showAlert('ì •ë‹µì…ë‹ˆë‹¤! íŒíŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.');
                const hintElement = document.createElement('li');
                hintElement.textContent = puzzle.hint;
                hintsList.appendChild(hintElement);
                solvedPuzzles.push(puzzle.id);
            };

            const handleWrongAnswer = async () => {
                wrongAnswerCount++;
                updateWrongAnswerDisplay();
                if (wrongAnswerCount >= MAX_WRONG_ANSWERS) {
                    // Give a moment for wrong answer display to update before game over
                    setTimeout(triggerGameOver, 100); 
                } else {
                    await showAlert('ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.');
                }
            };

            const handleObjectClick = async (obj) => {
                if (solvedPuzzles.includes(obj.id)) {
                    await showAlert('ì´ë¯¸ í•´ê²°í•œ ë¬¸ì œì…ë‹ˆë‹¤.');
                    return;
                }
                const userAnswer = await showPrompt(obj.puzzle, obj.validation);
                if (userAnswer === null) return; // User cancelled

                if (userAnswer.toLowerCase().trim() === obj.answer.toLowerCase().trim()) {
                    await handlePuzzleSolved(obj);
                    obj.element.classList.add('solved');
                } else {
                    await handleWrongAnswer();
                }
            };
            
            const handleEraClueClick = async () => {
                const room = gameData[currentRoomIndex];
                const unsolvedPuzzle = room.eraPuzzles.find(p => !solvedPuzzles.includes(p.id));
                if (!unsolvedPuzzle) {
                    await showAlert('ì´ê³³ì˜ ëª¨ë“  ë‹¨ì„œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }
                const userAnswer = await showPrompt(unsolvedPuzzle.puzzle, unsolvedPuzzle.validation);
                if (userAnswer === null) return; // User cancelled

                if (userAnswer.toLowerCase().trim() === unsolvedPuzzle.answer.toLowerCase().trim()) {
                    await handlePuzzleSolved(unsolvedPuzzle);
                    updateEraClueButtonState();
                } else {
                    await handleWrongAnswer();
                }
            };

            const checkPassword = async () => {
                const room = gameData[currentRoomIndex];
                if (passwordInput.value.trim() === room.password) {
                    if (currentRoomIndex < gameData.length - 1) {
                        await showAlert('ì •ë‹µ! ë‹¤ìŒ ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                        transitionToNextRoom();
                    } else {
                        await endGame();
                    }
                } else {
                    await showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                }
            };

            // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
            startButton.addEventListener('click', startGame);
            passwordSubmit.addEventListener('click', checkPassword);
            eraClueButton.addEventListener('click', handleEraClueClick);
            passwordInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') checkPassword();
            });
            restartFromGameOverButton.addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                startScreen.style.display = 'flex';
            });

            updateBestRecordDisplay();
        });
    </script>

</body>
</html>
